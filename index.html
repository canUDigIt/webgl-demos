<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebGL experimentation</title>

    <!-- JQUERY Libs //-->
    <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    <!-- MATH Libs //-->
    <script src="js/math/gl-matrix.js"></script>
    <!-- WEBGL Libs //-->
    <script src="https://rawgithub.com/mrdoob/three.js/master/build/three.js"></script>
    <script src="js/webgl/Utils.js"></script>
    <script src="js/physics/Liquid.js"></script>
    <script src="js/physics/Mover.js"></script>

    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec4 a_Position;

        uniform mat4 u_MVMatrix;
        uniform mat4 u_PMatrix;

        void main() {
           gl_Position = u_PMatrix * u_MVMatrix * a_Position;
           gl_PointSize = 10.0;
        }
    </script>

    <script id="shader-fs" type="x-shader/x-fragment">
        precision mediump float;

        uniform vec4 u_FragColor;

        void main() {
           gl_FragColor = u_FragColor;
        }
    </script>

    <script id="code-js" type="text/javascript">

        var mouseLocation;

        function runThreeJsApp() {
            configure();
            load();
            render();
        }

        (function() {

            var canvas, c_width, c_height, halfWidth, halfHeight;

            var scene;
            var camera;

            var renderer;

            var mover, circle;
            var liquid, rectangle;

            var animationRate = 15; // 15ms
            var initialTime = (new Date).getTime();
            var elapsedTime;
            var sceneTime = 0.0;

            window.configure = function() {
                canvas = document.getElementById("canvas-id");
                c_width = canvas.width;
                c_height = canvas.height;

                halfWidth = c_width / 2;
                halfHeight = c_height / 2;

                mouseLocation = new THREE.Vector3(halfWidth, halfHeight, 0);

                scene = new THREE.Scene();
                camera = new THREE.OrthographicCamera( -halfWidth, halfWidth, halfHeight, -halfHeight, 1, 1000);

                renderer =  new THREE.WebGLRenderer( { canvas: canvas } );
                renderer.setSize(c_width, c_height);
            };

            window.load = function() {
                mover = new Mover( halfWidth, halfHeight, 0, 20 );

                var geometry = new THREE.CircleGeometry(mover.mass / 2);
                var material = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
                circle = new THREE.Mesh( geometry, material );

                circle.position.setX(halfWidth);
                circle.position.setY(halfHeight);

                scene.add(circle);

                liquid = new Liquid( 0, 0, c_width, c_height / 3, 0.1 );

                var rectGeometry = new THREE.CubeGeometry(liquid.width, liquid.height, 0);
                var rectMaterial = new THREE.MeshBasicMaterial( { color: 0x0000ff } );

                rectangle = new THREE.Mesh( rectGeometry, rectMaterial );
                rectangle.position.setX(liquid.x);
                rectangle.position.setY(liquid.y);

                scene.add(rectangle);

                camera.position.setX(halfWidth);
                camera.position.setY(halfHeight);
                camera.position.setZ(2);
            };

            window.render = function() {
                Utils.requestAnimFrame(render);

                elapsedTime = ( (new Date).getTime() - initialTime );
                if (elapsedTime < animationRate) return;

                var steps = Math.floor( elapsedTime / animationRate );
                while(steps > 0) {
                    animate();
                    renderer.render(scene, camera);
                    steps -= 1;
                }

                initialTime = (new Date).getTime();
            };

            function animate() {
                var gravity = new THREE.Vector3(0, -0.1, 0);

                var friction = new THREE.Vector3();
                var frictionMagnitude = 0.01;
                friction.copy(mover.velocity);
                friction.normalize().negate();
                friction.multiplyScalar(frictionMagnitude);

                mover.applyForce(gravity);
                mover.applyForce(friction);

                if (mover.isInside(liquid)) {
                    mover.drag(liquid);
                }

                mover.update(sceneTime);
                mover.checkEdges(c_width, c_height);

                circle.position.copy(mover.position);

                sceneTime += 33/1000;
            }
            
        }());

    </script>
</head>
<body onload="runThreeJsApp()">
    <canvas id="canvas-id" width="400" height="400">
        Please use a browser supporting "canvas"
    </canvas>

    <script type="text/javascript">
        $("#canvas-id").mousemove( function(event) {
            mouseLocation.setX(event.pageX);
            mouseLocation.setY(this.width - event.pageY);
        } );
    </script>
</body>
</html>