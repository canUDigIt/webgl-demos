<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draw a point (1)</title>

    <!-- JQUERY Libs //-->
    <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    <!-- MATH Libs //-->
    <script src="js/math/gl-matrix.js"></script>
    <!-- WEBGL Libs //-->
    <script src="js/webgl/Globals.js"></script>
    <script src="js/webgl/Program.js"></script>
    <script src="js/webgl/Utils.js"></script>
    <script src="js/webgl/WebGLApp.js"></script>

    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec4 a_Position;

        uniform mat4 u_MVMatrix;
        uniform mat4 u_PMatrix;

        void main() {
           gl_Position = u_PMatrix * u_MVMatrix * a_Position;
           gl_PointSize = 10.0;
        }
    </script>

    <script id="shader-fs" type="x-shader/x-fragment">
        precision mediump float;

        uniform vec4 u_FragColor;

        void main() {
           gl_FragColor = u_FragColor;
        }
    </script>

    <script id="code-js" type="text/javascript">
        var app = null;
        function runWebGLApp() {
            app = new WebGLApp("canvas-id");
            app.configureGLHook = configure;
            app.loadSceneHook   = load;
            app.drawSceneHook   = draw;
            app.run();

            startAnimation();
        }

        function configure() {
            WEBGLAPP_RENDER_RATE = 30;

            mover = new Mover(200.0, 200.0);

            mouseLocation = vec3.create();
            vec3.copy(mouseLocation, mover.position);

            gl.clearColor(0.0, 0.0, 0.0, 1.0);

            vertexBuffer = gl.createBuffer();
            uploadBufferData(mover.position);

            var attributeList = [ "a_Position" ];

            var uniformList = [ "u_MVMatrix",
                                "u_PMatrix",
                                "u_FragColor"
                              ];

            Program.load(attributeList, uniformList);

            color = vec4.fromValues(1.0, 0.0, 0.0, 1.0);

            u_MVMatrix = mat4.create();
            mat4.translate(u_MVMatrix, u_MVMatrix, [-200, -200, -1]);

            u_PMatrix = mat4.create();
            mat4.ortho(u_PMatrix, -200, 200, -200, 200, 1, 100);

            gl.uniform4fv(Program.u_FragColor, color);
            gl.uniformMatrix4fv(Program.u_MVMatrix, false, u_MVMatrix);
            gl.uniformMatrix4fv(Program.u_PMatrix, false, u_PMatrix);
        }

        function uploadBufferData(data) {
            gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);
        }

        function load() {

        }

        function draw() {
            gl.viewport(0, 0, c_width, c_height);
            gl.clear(gl.COLOR_BUFFER_BIT);

            uploadBufferData(mover.position);

            gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
            gl.vertexAttribPointer(Program.a_Position, 3, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(Program.a_Position);

            gl.drawArrays(gl.POINTS, 0, 1);
        }

        var animationRate = 15; // 15ms
        var elapsedTime;
        var initialTime;
        var sceneTime = 0.0;

        function startAnimation() {
            initialTime = (new Date).getTime();
            setInterval(onFrame, animationRate/1000);
        }

        function onFrame() {
            elapsedTime = ( (new Date).getTime() - initialTime );
            if (elapsedTime < animationRate) return;

            var steps = Math.floor( elapsedTime / animationRate );
            while(steps > 0) {
                animate();
                steps -= 1;
            }

            initialTime = (new Date).getTime();
        }

        function animate() {
            mover.update(sceneTime, mouseLocation);

            sceneTime += 33/1000;
            draw();
        }

        function Mover(x, y){
            this.position = vec3.fromValues(x, y, 0.0);
            this.speed = vec3.create();
            this.acceleration = vec3.create();
        }

        Mover.prototype.update = function(time, mousePosition) {
            vec3.subtract(this.acceleration, mousePosition, this.position);

            var accelerationLimit = 0.5;
            this.limitValue(this.acceleration, accelerationLimit);
            
            vec3.add(this.speed, this.speed, this.acceleration);

            var speedLimit = 5;
            this.limitValue(this.speed, speedLimit);

            vec3.add(this.position, this.position, this.speed);
        };

        Mover.prototype.limitValue = function(vector, limit) {
            if (vec3.length(vector) > limit){
                vec3.normalize(vector, vector);
                vec3.scale(vector, vector, limit);
            }
        };

    </script>
</head>
<body onload="runWebGLApp()">
    <canvas id="canvas-id" width="400" height="400">
        Please use a browser supporting "canvas"
    </canvas>

    <script type="text/javascript">
        $("#canvas-id").mousemove( function(event) {
            mouseLocation[0] = event.pageX;
            mouseLocation[1] = this.width - event.pageY;
        } );
    </script>
</body>
</html>