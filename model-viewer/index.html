<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Model Viewer</title>

    <!-- JQUERY Libs //-->
    <script src="js/lib/jquery.min.js"></script>

    <!-- WEBGL Libs //-->
    <script src="js/lib/twgl-full.js"></script>

    <! -- Shaders //-->
    <script id="vs" type="x-shader/x-vertex">
        attribute vec4 position;

        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;

        void main() 
        {
           gl_Position = uPMatrix * uMVMatrix * position;
        }
    </script>

    <script id="fs" type="x-shader/x-fragment">
        void main()
        {
            gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
        }
    </script>

    <script>
        $(document).ready(function() {
            var gl = document.getElementById("c").getContext("webgl");
            var programInfo = twgl.createProgramInfo(gl, ["vs", "fs"]);
            var m4 = twgl.m4;
            var fovRadians = Math.PI / 4;
            var aspectRatio = gl.canvas.width / gl.canvas.height;
            var near = 0.1;
            var far = 100.0;
            var perspective = m4.perspective(fovRadians, aspectRatio, near, far);
            var camera = m4.identity();
            var distance = [0, 0, 5];
            var yaw = 0;
            var pitch = 0;
            var roll = 0;


            var myRequest = new Request('box.json');

            fetch(myRequest)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    var mesh = data.meshes[0];
                    var arrays = {
                        position: mesh.vertices,
                        normal: mesh.normals,
                        indices: []
                    };
                    
                    mesh.faces.forEach(function(face) {
                        arrays.indices.push(face[0]);
                        arrays.indices.push(face[1]);
                        arrays.indices.push(face[2]);
                    });

                    var bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);

                    function yawPitchRoll() {
                        var rotation = m4.identity();
                         m4.rotateY(rotation, yaw, rotation);
                         m4.rotateX(rotation, pitch, rotation); 
                         m4.rotateZ(rotation, roll, rotation);
                         return rotation;
                    }

                    function render(time) {
                        gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
                        gl.clearColor(0, 0, 0, 1);
                        gl.clear(gl.COLOR_BUFFER_BIT);

                        var uniforms = {
                            uMVMatrix: m4.inverse(m4.multiply(yawPitchRoll(), m4.translation(distance))),
                            uPMatrix: perspective
                        };

                        gl.useProgram(programInfo.program);
                        twgl.setBuffersAndAttributes(gl, programInfo, bufferInfo);
                        twgl.setUniforms(programInfo, uniforms);
                        twgl.drawBufferInfo(gl, bufferInfo);

                        requestAnimationFrame(render);
                    }

                    requestAnimationFrame(render);
                });

            var dragging = false;
            var startX, startY;
            $(gl.canvas).mousedown(function(event) {
                event.preventDefault();
                startX = event.pageX;
                startY = event.pageY;
                dragging = true;
            });

            $(gl.canvas).mouseup(function(event) {
                event.preventDefault();
                dragging = false;
            });

            $(gl.canvas).mousemove(function(event) {
                event.preventDefault();
                if (dragging) {
                    deltaX = event.pageX - startX;
                    deltaY = event.pageY - startY;
                    startX = event.pageX;
                    startY = event.pageY;
                    var xWeight = 2 * Math.PI / gl.canvas.width;
                    var yWeight = (Math.PI / 4) / gl.canvas.height;
                    pitch += deltaY * yWeight;
                    yaw += deltaX * xWeight;
                }
            });
        });
    </script>
</head>
<body>
    <canvas id="c" width="400" height="400">
        Please use a browser supporting "canvas"
    </canvas>

    <script type="text/javascript">

        
    </script>
</body>
</html>
